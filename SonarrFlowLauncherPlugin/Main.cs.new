using System.Windows.Controls;
using Flow.Launcher.Plugin;
using SonarrFlowLauncherPlugin.Services;

namespace SonarrFlowLauncherPlugin
{
    public class Main : IPlugin, ISettingProvider
    {
        private PluginInitContext _context;
        private readonly Settings _settings;
        private readonly SonarrService _sonarrService;
        private readonly SettingsControl _settingsControl;

        public Main()
        {
            _settings = Settings.Load();
            _sonarrService = new SonarrService(_settings);
            _settingsControl = new SettingsControl(_settings);
        }

        public void Init(PluginInitContext context)
        {
            _context = context;
        }

        public List<Result> Query(Query query)
        {
            if (string.IsNullOrEmpty(_settings.ApiKey))
            {
                return new List<Result>
                {
                    new Result
                    {
                        Title = "Sonarr API Key Not Set",
                        SubTitle = "Please set your Sonarr API key in the plugin settings",
                        IcoPath = "Images\\icon.png",
                        Action = _ => false
                    }
                };
            }

            if (string.IsNullOrEmpty(query.Search))
            {
                return new List<Result>
                {
                    new Result
                    {
                        Title = "Search Sonarr",
                        SubTitle = "Type to search your Sonarr library",
                        IcoPath = "Images\\icon.png",
                        Action = _ => false
                    },
                    new Result
                    {
                        Title = "Sonarr Activity",
                        SubTitle = "View current downloads and recent history",
                        IcoPath = "Images\\icon.png",
                        Action = _ => _sonarrService.OpenActivityInBrowser().Result
                    }
                };
            }

            // Check if the query is for activity
            if (query.Search.ToLower().StartsWith("activity"))
            {
                var results = new List<Result>();
                try
                {
                    var activity = _sonarrService.GetActivityAsync().Result;
                    
                    // Add queue items
                    foreach (var item in activity.Queue)
                    {
                        results.Add(new Result
                        {
                            Title = $"â¬‡ï¸ {item.Title}",
                            SubTitle = $"S{item.SeasonNumber:D2}E{item.EpisodeNumber:D2} - {item.Status} ({item.Progress:F1}%) - {item.Quality}",
                            IcoPath = "Images\\icon.png",
                            Score = 100
                        });
                    }

                    // Add history items
                    foreach (var item in activity.History)
                    {
                        var icon = item.EventType.ToLower() switch
                        {
                            "grabbed" => "â¬‡ï¸",
                            "downloadfolderimported" => "âœ…",
                            "downloadfailed" => "âŒ",
                            _ => "ðŸ“"
                        };

                        results.Add(new Result
                        {
                            Title = $"{icon} {item.Title}",
                            SubTitle = $"S{item.SeasonNumber:D2}E{item.EpisodeNumber:D2} - {item.EventType} - {item.Date:g}",
                            IcoPath = "Images\\icon.png",
                            Score = 90
                        });
                    }

                    if (!results.Any())
                    {
                        results.Add(new Result
                        {
                            Title = "No Recent Activity",
                            SubTitle = "No downloads in progress or recent history",
                            IcoPath = "Images\\icon.png",
                            Score = 100
                        });
                    }

                    // Add option to open in browser
                    results.Add(new Result
                    {
                        Title = "Open Activity in Browser",
                        SubTitle = "View full activity in Sonarr",
                        IcoPath = "Images\\icon.png",
                        Score = 80,
                        Action = _ => _sonarrService.OpenActivityInBrowser().Result
                    });

                    return results;
                }
                catch (Exception ex)
                {
                    return new List<Result>
                    {
                        new Result
                        {
                            Title = "Error Getting Activity",
                            SubTitle = $"Error: {ex.Message}",
                            IcoPath = "Images\\icon.png",
                            Score = 100
                        }
                    };
                }
            }

            var results = new List<Result>();
            
            try
            {
                System.Diagnostics.Debug.WriteLine($"Searching for: {query.Search}");
                var series = _sonarrService.SearchSeriesAsync(query.Search).Result;
                System.Diagnostics.Debug.WriteLine($"Found {series.Count} results");

                if (series.Count == 0)
                {
                    results.Add(new Result
                    {
                        Title = "No Results Found",
                        SubTitle = $"No shows found matching '{query.Search}'",
                        IcoPath = "Images\\icon.png",
                        Score = 100,
                        Action = _ => false
                    });
                }

                foreach (var show in series)
                {
                    var stats = show.Statistics ?? new Models.SeriesStatistics();
                    var episodeInfo = $"{stats.EpisodeFileCount}/{stats.TotalEpisodeCount} Episodes";
                    if (stats.TotalEpisodeCount == 0)
                    {
                        episodeInfo = "No Episodes";
                    }

                    results.Add(new Result
                    {
                        Title = show.Title,
                        SubTitle = $"{show.Network} | {show.Status} | {stats.SeasonCount} Seasons | {episodeInfo}",
                        IcoPath = !string.IsNullOrEmpty(show.PosterPath) ? show.PosterPath : "Images\\icon.png",
                        Score = 100,
                        Action = _ =>
                        {
                            return _sonarrService.OpenSeriesInBrowser(show.Id).Result;
                        }
                    });
                }
            }
            catch (Exception ex)
            {
                var errorMessage = ex.InnerException?.Message ?? ex.Message;
                System.Diagnostics.Debug.WriteLine($"Error in Query: {errorMessage}");
                
                results.Add(new Result
                {
                    Title = "Error Connecting to Sonarr",
                    SubTitle = $"Error: {errorMessage}",
                    IcoPath = "Images\\icon.png",
                    Score = 100,
                    Action = _ => false
                });
            }

            return results;
        }

        public Control CreateSettingPanel()
        {
            return _settingsControl;
        }
    }
} 